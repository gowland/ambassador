<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe Manager</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üç≥ Recipe Manager</h1>
            <p>Add and manage your favorite recipes</p>
        </header>

        <main>
            <section class="add-recipe">
                <h2>Add Ingredient for Recipe</h2>
                <form id="recipeForm">
                    <div class="form-group">
                        <label for="recipeName">Recipe Name:</label>
                        <input type="text" id="recipeName" name="recipeName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="ingredients">Ingredients:</label>
                        <div id="ingredientsContainer">
                            <div class="ingredient-input">
                                <input type="text" name="ingredient" placeholder="Enter an ingredient" required>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn-primary">Save Recipe</button>
                </form>
            </section>

            <section class="recipes-list">
                <h2>Your Recipes</h2>
                <div id="recipesList">
                    <p class="loading">Loading recipes...</p>
                </div>
            </section>
        </main>
    </div>

    <div id="notification" class="notification hidden"></div>

    <script src="app.js"></script>
    <script>
        // Ensure form submission works when Save Recipe button is clicked
        document.addEventListener('DOMContentLoaded', function() {
            const recipeForm = document.getElementById('recipeForm');
            const saveButton = document.querySelector('.btn-primary');
            
            // Handle Save Recipe button click
            saveButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                const recipeName = document.getElementById('recipeName').value.trim();
                const ingredientInputs = document.querySelectorAll('input[name="ingredient"]');
                
                // Collect all ingredients
                const ingredients = [];
                ingredientInputs.forEach(input => {
                    const value = input.value.trim();
                    if (value) {
                        ingredients.push(value);
                    }
                });

                if (!recipeName) {
                    showNotification('Please enter a recipe name', 'error');
                    return;
                }

                if (ingredients.length === 0) {
                    showNotification('Please add at least one ingredient', 'error');
                    return;
                }

                // Submit the recipe
                submitRecipe(recipeName, ingredients);
            });
            
            // Function to submit recipe to API
            async function submitRecipe(recipeName, ingredients) {
                try {
                    const response = await fetch(`/recipe/${encodeURIComponent(recipeName)}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ ingredients })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showNotification(`Recipe "${recipeName}" saved successfully!`, 'success');
                        resetForm();
                        loadRecipes(); // Refresh the recipes list
                    } else {
                        const error = await response.json();
                        showNotification(error.error || 'Failed to save recipe', 'error');
                    }
                } catch (error) {
                    console.error('Error saving recipe:', error);
                    showNotification('Failed to save recipe. Please try again.', 'error');
                }
            }
            
            // Function to reset form
            function resetForm() {
                recipeForm.reset();
                
                // Remove all but the first ingredient field
                const container = document.getElementById('ingredientsContainer');
                const ingredientInputs = container.querySelectorAll('.ingredient-input');
                
                for (let i = 1; i < ingredientInputs.length; i++) {
                    ingredientInputs[i].remove();
                }
                
                // Update remove buttons visibility
                const removeButtons = document.querySelectorAll('.remove-ingredient');
                removeButtons.forEach(btn => {
                    btn.style.display = 'none';
                });
            }
            
            // Function to show notifications
            function showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type} visible`;
                
                // Hide notification after 4 seconds
                setTimeout(() => {
                    notification.className = `notification ${type} hidden`;
                }, 4000);
            }
            
            // Function to load recipes
            async function loadRecipes() {
                const recipesList = document.getElementById('recipesList');
                
                try {
                    const response = await fetch('/api/recipes');
                    
                    if (!response.ok) {
                        throw new Error('Failed to fetch recipes');
                    }
                    
                    const recipes = await response.json();
                    
                    if (recipes.length === 0) {
                        recipesList.innerHTML = `
                            <div class="empty-state">
                                <h3>No recipes yet</h3>
                                <p>Add your first recipe using the form above!</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Sort recipes alphabetically
                    recipes.sort((a, b) => a.name.localeCompare(b.name));
                    
                    recipesList.innerHTML = recipes.map(recipe => `
                        <div class="recipe-card">
                            <h3>${escapeHtml(recipe.name)}</h3>
                            <ul class="ingredients-list">
                                ${recipe.ingredients.map(ingredient => 
                                    `<li>${escapeHtml(ingredient)}</li>`
                                ).join('')}
                            </ul>
                        </div>
                    `).join('');
                    
                } catch (error) {
                    console.error('Error loading recipes:', error);
                    recipesList.innerHTML = `
                        <div class="empty-state">
                            <h3>Error loading recipes</h3>
                            <p>Please refresh the page to try again.</p>
                        </div>
                    `;
                }
            }
            
            // Function to escape HTML
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Load recipes on page load
            loadRecipes();
        });
    </script>
</body>
</html>